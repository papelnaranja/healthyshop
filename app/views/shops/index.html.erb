<p id="notice"><%= notice %></p>

<h1>Shops</h1>

<div style='width: 100%;'>
  <div id="map" style='width: 100%; height: 100vh;'></div>
</div>

<form action="<%= shops_path %>" method="get" class="form-inline">
  <div class="form-group">
    <label for="q">Busqueda</label>
    <input type="text" name="q" class="form-control">
  </div>
</form>

<table class="table-striped table">
  <thead>
    <tr>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Name</th>
      <th>Photo</th>
      <th>Description</th>
      <th>Satate</th>
      <th>Address</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @shops.each do |shop| %>
      <tr>
        <td><%= shop.longitude %></td>
        <td><%= shop.latitude %></td>
        <td><%= shop.name %></td>
        <td><%= shop.photo %></td>
        <td><%= shop.description %></td>
        <td><%= shop.state %></td>
        <td><%= shop.address %></td>
        <td><%= link_to 'Show', shop %></td>
        <td><%= link_to 'Edit', edit_shop_path(shop) %></td>
        <td><% link_to 'Destroy', shop, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>


<div class="form-wrap">
<%= form_with(model: @shop , local: true, scope: "shop") do |form| %>

  <div class="field">
    <%= form.label :longitude %>
    <%= form.text_field :longitude %>
  </div>

  <div class="field">
    <%= form.label :latitude %>
    <%= form.text_field :latitude %>
  </div>

  <div class="field">
    <%= form.label :name %>
    <%= form.text_field :name %>
  </div>

  <div class="field">
    <%= form.label :photo %>
    <%= form.text_field :photo %>
  </div>

  <div class="field">
    <%= form.label :description %>
    <%= form.text_field :description %>
  </div>
  <% if current_user.role == "admin" %>
    <div class="field">
      <%= form.label :state %>
      <%= form.select :state, options_for_select([["Draft", :draft],["Publicado",:published],["Escondido",:hidden]], params[:state] ) %>
    </div>
  <% end %>
  
  <div class="field">
    <%= form.label :address %>
    <%= form.text_field :address %>
  </div>

  <div class="actions">
    <%= form.submit %>
  </div>
<% end %>

</div>

  <div id="tiendas">
     
  </div>


<%= link_to 'New Shop', new_shop_path %>

<script>
var userLat;
var userLong;

function currentPosition(position) {
  userLat = position.coords.latitude;
  userLong = position.coords.longitude;
  console.log('More or less ' + position.coords.accuracy + ' meters.');
}

navigator.geolocation.getCurrentPosition(currentPosition);

handler = Gmaps.build('Google');
handler.buildMap({
    provider: {
      center: new google.maps.LatLng({lat: 0, lng: 0}),
      zoom: 15
    },
    internal: {
      id: 'map'
    }
},
  function(){
    markers = handler.addMarkers(<%= raw @hash.to_json %>);
    google.maps.event.addListener(handler.getMap(), "click", function(event){
      var latitude = event.latLng.lat();
      var longitude = event.latLng.lng();      
      console.log(latitude, longitude);
      $('#shop_longitude').val(longitude);
      $('#shop_latitude').val(latitude);
      addMarker(event.latLng);
      //console.log(event.latLng)
    });

  }
);

var userMarker;
function addMarker(location) {
  if (userMarker) {
    userMarker.setPosition(location);
  } else {
    userMarker = new google.maps.Marker({
      position: location,
      map: handler.getMap()
    });
  }

}





</script>